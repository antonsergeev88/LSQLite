import LSQLite
import MissedSwiftSQLite
import Testing

@Suite("Connection+Open")
struct ConnectionOpenTests {
    @Test("FileName init(rawValue:) preserves rawValue")
    func fileNameRawValueRoundTrip() {
        let rawValue = "test.db"
        let fileName = Connection.FileName(rawValue: rawValue)
        #expect(fileName.rawValue == rawValue)
    }

    @Test("OpenFlag init(rawValue:) preserves rawValue")
    func openFlagRawValueRoundTrip() {
        let rawValue = Int32(0x1200)
        let openFlag = Connection.OpenFlag(rawValue: rawValue)
        #expect(openFlag.rawValue == rawValue)
    }

    @Test("OpenFlag init(rawValue:) preserves combined rawValue")
    func openFlagCombinedRawValueRoundTrip() {
        let rawValue = Connection.OpenFlag.readwrite.rawValue | Connection.OpenFlag.create.rawValue
        let openFlag = Connection.OpenFlag(rawValue: rawValue)
        #expect(openFlag.rawValue == rawValue)
    }

    @Test("OpenFlag constants match SQLite")
    func openFlagConstantsMatchSQLite() {
        #expect(Connection.OpenFlag.readonly.rawValue == SQLITE_OPEN_READONLY)
        #expect(Connection.OpenFlag.readwrite.rawValue == SQLITE_OPEN_READWRITE)
        #expect(Connection.OpenFlag.create.rawValue == SQLITE_OPEN_CREATE)
        #expect(Connection.OpenFlag.deleteOnClose.rawValue == SQLITE_OPEN_DELETEONCLOSE)
        #expect(Connection.OpenFlag.exclusive.rawValue == SQLITE_OPEN_EXCLUSIVE)
        #expect(Connection.OpenFlag.autoproxy.rawValue == SQLITE_OPEN_AUTOPROXY)
        #expect(Connection.OpenFlag.uri.rawValue == SQLITE_OPEN_URI)
        #expect(Connection.OpenFlag.memory.rawValue == SQLITE_OPEN_MEMORY)
        #expect(Connection.OpenFlag.mainDB.rawValue == SQLITE_OPEN_MAIN_DB)
        #expect(Connection.OpenFlag.tempDB.rawValue == SQLITE_OPEN_TEMP_DB)
        #expect(Connection.OpenFlag.transientDB.rawValue == SQLITE_OPEN_TRANSIENT_DB)
        #expect(Connection.OpenFlag.mainJournal.rawValue == SQLITE_OPEN_MAIN_JOURNAL)
        #expect(Connection.OpenFlag.tempJournal.rawValue == SQLITE_OPEN_TEMP_JOURNAL)
        #expect(Connection.OpenFlag.subjournal.rawValue == SQLITE_OPEN_SUBJOURNAL)
        #expect(Connection.OpenFlag.masterJournal.rawValue == SQLITE_OPEN_MASTER_JOURNAL)
        #expect(Connection.OpenFlag.noMutex.rawValue == SQLITE_OPEN_NOMUTEX)
        #expect(Connection.OpenFlag.fullMutex.rawValue == SQLITE_OPEN_FULLMUTEX)
        #expect(Connection.OpenFlag.sharedCache.rawValue == SQLITE_OPEN_SHAREDCACHE)
        #expect(Connection.OpenFlag.privateCache.rawValue == SQLITE_OPEN_PRIVATECACHE)
        #expect(Connection.OpenFlag.wal.rawValue == SQLITE_OPEN_WAL)
#if canImport(Darwin)
        #expect(Connection.OpenFlag.fileProtectionComplete.rawValue == SQLITE_OPEN_FILEPROTECTION_COMPLETE)
        #expect(Connection.OpenFlag.fileProtectionCompleteUnlessOpen.rawValue == SQLITE_OPEN_FILEPROTECTION_COMPLETEUNLESSOPEN)
        #expect(Connection.OpenFlag.fileProtectionCompleteUntilFirstUserAuthentication.rawValue == SQLITE_OPEN_FILEPROTECTION_COMPLETEUNTILFIRSTUSERAUTHENTICATION)
        #expect(Connection.OpenFlag.fileProtectionNone.rawValue == SQLITE_OPEN_FILEPROTECTION_NONE)
        #expect(Connection.OpenFlag.fileProtectionMask.rawValue == SQLITE_OPEN_FILEPROTECTION_MASK)
#endif
    }

    @Test("FileName description reflects rawValue")
    func fileNameDescriptionReflectsRawValue() {
        #expect(Connection.FileName.memory.description == ":memory:")
        #expect(Connection.FileName.temporary.description == "")
        #expect(Connection.FileName(rawValue: "custom.db").description == "custom.db")
    }

    @Test("OpenFlag descriptions map values")
    func openFlagDescriptions() {
        #expect(Connection.OpenFlag([]).description == "[]")
        #expect(Connection.OpenFlag.readwrite.description.contains(".readwrite"))
        #expect(Connection.OpenFlag(rawValue: 0x4000_0000).description == "unknown")
        let mixed = Connection.OpenFlag(rawValue: Connection.OpenFlag.readonly.rawValue | 0x4000_0000)
        #expect(mixed.description.contains("unknown"))
        #expect(Connection.OpenFlag.readonly.debugDescription.contains("SQLITE_OPEN_READONLY"))
        #expect(mixed.debugDescription.contains("0x"))
        #expect(Connection.OpenFlag(rawValue: 0x4000_0000).debugDescription.hasPrefix("0x"))
    }

    @Test("open creates an in-memory connection")
    func openCreatesInMemoryConnection() throws {
        let connection: Connection = try {
            var connection: Connection?
            try #require(Connection.open(&connection, at: .memory, withOpenFlags: [.readwrite, .create]) == .ok)
            return try #require(connection)
        }()
        #expect(connection.close() == .ok)
    }
}
