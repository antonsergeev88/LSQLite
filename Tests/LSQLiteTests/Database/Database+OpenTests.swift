import LSQLite
import MissedSwiftSQLite
import Testing

@Suite("Database+Open")
struct DatabaseOpenTests {
    @Test("FileName init(rawValue:) preserves rawValue")
    func fileNameRawValueRoundTrip() {
        let rawValue = "test.db"
        let fileName = Database.FileName(rawValue: rawValue)
        #expect(fileName.rawValue == rawValue)
    }

    @Test("OpenFlag init(rawValue:) preserves rawValue")
    func openFlagRawValueRoundTrip() {
        let rawValue = Int32(0x1200)
        let openFlag = Database.OpenFlag(rawValue: rawValue)
        #expect(openFlag.rawValue == rawValue)
    }

    @Test("OpenFlag init(rawValue:) preserves combined rawValue")
    func openFlagCombinedRawValueRoundTrip() {
        let rawValue = Database.OpenFlag.readwrite.rawValue | Database.OpenFlag.create.rawValue
        let openFlag = Database.OpenFlag(rawValue: rawValue)
        #expect(openFlag.rawValue == rawValue)
    }

    @Test("OpenFlag constants match SQLite")
    func openFlagConstantsMatchSQLite() {
        #expect(Database.OpenFlag.readonly.rawValue == SQLITE_OPEN_READONLY)
        #expect(Database.OpenFlag.readwrite.rawValue == SQLITE_OPEN_READWRITE)
        #expect(Database.OpenFlag.create.rawValue == SQLITE_OPEN_CREATE)
        #expect(Database.OpenFlag.deleteOnClose.rawValue == SQLITE_OPEN_DELETEONCLOSE)
        #expect(Database.OpenFlag.exclusive.rawValue == SQLITE_OPEN_EXCLUSIVE)
        #expect(Database.OpenFlag.autoproxy.rawValue == SQLITE_OPEN_AUTOPROXY)
        #expect(Database.OpenFlag.uri.rawValue == SQLITE_OPEN_URI)
        #expect(Database.OpenFlag.memory.rawValue == SQLITE_OPEN_MEMORY)
        #expect(Database.OpenFlag.mainDB.rawValue == SQLITE_OPEN_MAIN_DB)
        #expect(Database.OpenFlag.tempDB.rawValue == SQLITE_OPEN_TEMP_DB)
        #expect(Database.OpenFlag.transientDB.rawValue == SQLITE_OPEN_TRANSIENT_DB)
        #expect(Database.OpenFlag.mainJournal.rawValue == SQLITE_OPEN_MAIN_JOURNAL)
        #expect(Database.OpenFlag.tempJournal.rawValue == SQLITE_OPEN_TEMP_JOURNAL)
        #expect(Database.OpenFlag.subjournal.rawValue == SQLITE_OPEN_SUBJOURNAL)
        #expect(Database.OpenFlag.masterJournal.rawValue == SQLITE_OPEN_MASTER_JOURNAL)
        #expect(Database.OpenFlag.noMutex.rawValue == SQLITE_OPEN_NOMUTEX)
        #expect(Database.OpenFlag.fullMutex.rawValue == SQLITE_OPEN_FULLMUTEX)
        #expect(Database.OpenFlag.sharedCache.rawValue == SQLITE_OPEN_SHAREDCACHE)
        #expect(Database.OpenFlag.privateCache.rawValue == SQLITE_OPEN_PRIVATECACHE)
        #expect(Database.OpenFlag.wal.rawValue == SQLITE_OPEN_WAL)
#if canImport(Darwin)
        #expect(Database.OpenFlag.fileProtectionComplete.rawValue == SQLITE_OPEN_FILEPROTECTION_COMPLETE)
        #expect(Database.OpenFlag.fileProtectionCompleteUnlessOpen.rawValue == SQLITE_OPEN_FILEPROTECTION_COMPLETEUNLESSOPEN)
        #expect(Database.OpenFlag.fileProtectionCompleteUntilFirstUserAuthentication.rawValue == SQLITE_OPEN_FILEPROTECTION_COMPLETEUNTILFIRSTUSERAUTHENTICATION)
        #expect(Database.OpenFlag.fileProtectionNone.rawValue == SQLITE_OPEN_FILEPROTECTION_NONE)
        #expect(Database.OpenFlag.fileProtectionMask.rawValue == SQLITE_OPEN_FILEPROTECTION_MASK)
#endif
    }

    @Test("FileName description reflects rawValue")
    func fileNameDescriptionReflectsRawValue() {
        #expect(Database.FileName.memory.description == ":memory:")
        #expect(Database.FileName.temporary.description == "")
        #expect(Database.FileName(rawValue: "custom.db").description == "custom.db")
    }

    @Test("OpenFlag descriptions map values")
    func openFlagDescriptions() {
        #expect(Database.OpenFlag([]).description == "[]")
        #expect(Database.OpenFlag.readwrite.description.contains(".readwrite"))
        #expect(Database.OpenFlag(rawValue: 0x4000_0000).description == "unknown")
        let mixed = Database.OpenFlag(rawValue: Database.OpenFlag.readonly.rawValue | 0x4000_0000)
        #expect(mixed.description.contains("unknown"))
        #expect(Database.OpenFlag.readonly.debugDescription.contains("SQLITE_OPEN_READONLY"))
        #expect(mixed.debugDescription.contains("0x"))
        #expect(Database.OpenFlag(rawValue: 0x4000_0000).debugDescription.hasPrefix("0x"))
    }

    @Test("open creates an in-memory database")
    func openCreatesInMemoryDatabase() throws {
        var database: Database?
        try #require(Database.open(&database, at: .memory, withOpenFlags: [.readwrite, .create]) == .ok)
        let openDatabase = try #require(database)
        #expect(openDatabase.close() == .ok)
    }
}
